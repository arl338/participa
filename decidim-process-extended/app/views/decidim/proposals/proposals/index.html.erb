<%= render partial: "decidim/shared/feature_announcement" %>

<% if feature_settings.geocoding_enabled? %>
  <%= dynamic_map_for proposals_data_for_map(geocoded_proposals) do %>
    <template id="marker-popup">
      <div class="map-info__content">
        <h3>${title}</h3>
        <div id="bodyContent">
          <p>{{html body}}</p>
          <div class="map__date-adress">
            <div class="address card__extra">
              <div class="address__icon">{{html icon}}</div>
              <div class="address__details">
                <span>${address}</span><br />
              </div>
            </div>
          </div>
          <div class="map-info__button">
            <a href="${link}" class="button button--sc">
              <%= t('.view_proposal') %>
            </a>
          </div>
        </div>
      </div>
    </template>
    <%= stylesheet_link_tag "decidim/map" %>
    <%= javascript_include_tag "decidim/map" %>
  <% end %>
<% end %>
<%= render partial: "votes_limit" %>
<% if params.has_key?(:menu) or !has_categories(params[:participatory_process_slug]) %>
  <% if params[:menu] == "true" or !has_categories(params[:participatory_process_slug]) %>
    <!--
    <div class="row columns part-padding-b-15">
      <a href="/processes/<%= params[:participatory_process_slug] %>" class="part-cont-5">Inici</a> / 
      <a href="/processes/<%= params[:participatory_process_slug] %>" class="part-cont-5">
        <% process_name(params[:participatory_process_slug]).each do |proceso| %><%= translated_attribute(proceso.title) %><% end %> /
      </a>
      <a href="/processes/<%= params[:participatory_process_slug] %>/f/<%= params[:feature_id] %>" class="part-cont-5">Eixos de debat</a> /
      <% if params.has_key?(:filter)  %>
        <a href="/processes/<%= params[:participatory_process_slug] %>/f/<%= params[:feature_id] %>" class="part-cont-5">
          <% my_category(params[:filter][:category_id]).each do |proceso| %><%= translated_attribute(proceso.name) %><% end %>
        </a> /
      <% end %>
      <a href="/processes/<%= params[:participatory_process_slug] %>/f/<%= params[:feature_id] %>" class="part-cont-4">Propostes</a>
    </div>
    -->
    <div class="row columns part-timeline-margin">
      <div class="title-action">
        <h2 id="proposals-count" class="title-action__title section-heading">
          <%= render partial: "count" %>
        </h2>
        <% if current_settings.creation_enabled %>
          <%= action_authorized_link_to :create, new_proposal_path, class: "title-action__action button small hollow" do %>
            <%= t(".new_proposal") %>
            <%= icon "plus" %>
          <% end %>
        <% else %>
          <span class="title-action__action button small hollow disabled">
            <%= t(".new_proposal") %>
            <%= icon "plus" %>
          </span>
        <% end %>
        <div class="fwk-col-md-12 part-timeline-margin">

        <% if current_feature.categories.any? %>
          <% current_feature.categories.first_class.each do |category| %>
            <% if category.id.to_s == @category_id %>
              <div class="timeline__info part-panel-default category_description" id="category_description_<%= category.id %>">
                  <div class="timeline__content">
                      <p><%= translated_attribute(category.description).html_safe %></p>
                  </div>
              </div>
            <% else %>
              <div class="timeline__info part-panel-default part-hide category_description" id="category_description_<%= category.id %>">
                  <div class="timeline__content">
                      <p><%= translated_attribute(category.description).html_safe %></p>
                  </div>
              </div>
            <% end %>
          <% end %>

        <% end %>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="columns mediumlarge-4 large-3">
        <%= render partial: "filters_small_view" %>
        <div class="card card--secondary show-for-mediumlarge" >
          <%= render partial: "filters" %>
        </div>
      </div>
      <div id="proposals" class="columns mediumlarge-8 large-9">
        <%= render partial: "proposals" %>
      </div>
    </div>

    <%= javascript_include_tag("decidim/filters") %>
    <%= javascript_include_tag "decidim/orders" %>
  <% end %>
<% elsif %>
<!--
  <div class="row columns part-padding-b-15">
    <a href="/processes/<%= params[:participatory_process_slug] %>" class="part-cont-5">Inici</a> / 
    <a href="/processes/<%= params[:participatory_process_slug] %>" class="part-cont-5">
      <% process_name(params[:participatory_process_slug]).each do |proceso| %><%= translated_attribute(proceso.title) %><% end %> /
    </a>
    <a href="/processes/<%= params[:participatory_process_slug] %>/f/<%= params[:feature_id] %>" class="part-cont-4">Eixos de debat</a>
  </div>
  -->
  <div class="row small-up-1 medium-up-2 card-grid">
    <% process_categories(params[:participatory_process_slug]).each do |category| %>
      <div class="column">
        <article class="card card--proposal">
          <div class="card__content">
            <div class="card__header">
              <a href="/processes/LraJM5Gb/f/2144/proposals/74601">
                <h5 class="card__title"></h5>
              </a>
              <div class="card__title part-bold">
                <%= translated_attribute(category.name) %>
              </div><% 
                #allow <br> breaks
                clean_desc  = sanitize translated_attribute(category.description), tags: %w(br)
                max_length  = 225
                
                if(clean_desc.length > max_length)
                  clean_desc = clean_desc[0..max_length-1] + '...'
                end
              %><div class="axis-description"><%= clean_desc %></div>
            </div>
          </div>
          <div class="card__support">
            <div class="card__support__data"></div>
            <a class="card__button button small" href="/processes/<%= params[:participatory_process_slug] %>/f/<%= params[:feature_id] %>?menu=true&&filter[category_id]=<%= category.id %>&menu=true"><%= t(".see_proposals") %></a>
          </div>
        </article>
      </div>
    <% end %>
  </div>
<% end %>